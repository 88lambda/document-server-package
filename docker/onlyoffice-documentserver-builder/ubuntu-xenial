FROM ubuntu:xenial
MAINTAINER Ascensio System SIA <support@onlyoffice.com>

ENV LANG=en_US.UTF-8 LANGUAGE=en_US:en LC_ALL=en_US.UTF-8 DEBIAN_FRONTEND=noninteractive QT_SELECT=qt56

RUN apt-get -y update && \
    apt-get install --force-yes -yq apt-transport-https locales software-properties-common curl && \
    curl -sL https://deb.nodesource.com/setup_4.x | bash - && \
    locale-gen en_US.UTF-8 && \
    apt-get -y update && \
    apt-get install --force-yes -yq \
        wget \
        build-essential \
        sed \
        dpkg-dev \
        debhelper \
        createrepo \
        bomstrip \
        libxml2-dev \
        libboost-regex-dev \
        libboost-system-dev \
        libboost-filesystem-dev \
        libcurl4-gnutls-dev \
        libglib2.0-dev \
        libgdk-pixbuf2.0-dev \
        libgtkglext1-dev \
        libatk1.0-dev \
        libcairo2-dev \
        libxss-dev \
        libgconf2-dev \
        default-jre \
        qtchooser \
        "^libxcb.*" \
        libx11-xcb-dev \
        libglu1-mesa-dev \
        libxrender-dev \
        libcups2-dev \
        nodejs && \
    wget http://download.qt.io/official_releases/qt/5.6/5.6.0/single/qt-everywhere-opensource-src-5.6.0.tar.gz && \
    tar -xvzf qt-everywhere-opensource-src-5.6.0.tar.gz && \
    rm qt-everywhere-opensource-src-5.6.0.tar.gz && \
    cd qt-everywhere-opensource-src-5.6.0 && \
    ./configure -opensource -confirm-license && \
    make -j $(grep -c ^processor /proc/cpuinfo) && \
    make install && \
    mkdir -p /etc/xdg/qtchooser && \
    printf "/usr/local/Qt-5.6.0/bin\n/usr/local/Qt-5.6.0/lib" > /etc/xdg/qtchooser/qt56.conf && \
    npm install -g grunt-cli && \
    npm cache clean && \
    rm -rf /var/lib/apt/lists/*

ADD build.sh /app/onlyoffice/build.sh
ADD build-bin.sh /app/onlyoffice/build-bin.sh
ADD build-desktop.sh /app/onlyoffice/build-desktop.sh
ADD build-desktop-deb.sh /app/onlyoffice/build-desktop-package.sh

VOLUME /var/lib/onlyoffice /home/oleg

CMD bash -C '/app/onlyoffice/build.sh'
